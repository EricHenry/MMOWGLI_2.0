package com.example.mmowgli_explore;

import java.sql.Timestamp;
import java.text.SimpleDateFormat;

import com.example.mmowgli_managers.Card;
import com.example.mmowgli_managers.CardList;
import com.vaadin.annotations.AutoGenerated;
import com.vaadin.server.ThemeResource;
import com.vaadin.ui.Alignment;
import com.vaadin.ui.Button.ClickEvent;
import com.vaadin.ui.ComboBox;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.HorizontalLayout;
import com.vaadin.ui.Label;
import com.vaadin.ui.NativeButton;
import com.vaadin.ui.Panel;
import com.vaadin.ui.TextField;
import com.vaadin.ui.VerticalLayout;

public class CardExplorationView extends CustomComponent {

	/*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */
	
	@AutoGenerated
	private HorizontalLayout mainLayout;


	@AutoGenerated
	private VerticalLayout verticalLayout_4;


	@AutoGenerated
	private Panel panel_cardChildren;


	@AutoGenerated
	private VerticalLayout verticalLayout_childView;


	@AutoGenerated
	private HorizontalLayout horizontalLayout_1;


	@AutoGenerated
	private ComboBox comboBox_1;


	@AutoGenerated
	private Label label_sort;


	@AutoGenerated
	private NativeButton nativeButton_search;


	@AutoGenerated
	private TextField textField_search;


	@AutoGenerated
	private Panel panel_currentCards;


	@AutoGenerated
	private VerticalLayout verticalLayout_mainView;


	@AutoGenerated
	private Panel panel_tree;


	@AutoGenerated
	private VerticalLayout verticalLayout_historyView;


	//Attributes
	private String chosenCardId;
	private CardView currentChosenCard = null;						//Keep track of the card view that has been clicked.
	private CardView[] currentlyDisplayedCards;						//Current List of cards listed in the middle panel
	private CardView[] currentlyDisplayedChildren;					//Current List of child cards being displyed
	private CardView[] currentCardHistory;							//Current History List being displayed
	
	//TODO change to updated version
	private CardView[] cardsToAdd	= new CardView[10];
	private CardView[] children		= new CardView[10];
	private CardView[] history		= new CardView[8];
	
	private CardList cardsToMainView;
	private CardList cardsToChildView;
	private CardList cardsToHistoryView;
	
	/**
	 * The constructor should first build the main layout, set the
	 * composition root and then do any custom initialization.
	 *
	 * The constructor will not be automatically regenerated by the
	 * visual editor.
	 */
	public CardExplorationView() {
		buildMainLayout();
		setCompositionRoot(mainLayout);
		
		//Instantiate Card Lists
		cardsToMainView = new CardList();
		cardsToChildView = new CardList();
		cardsToHistoryView = new CardList();
		
		//create random cards
		createRandomCards();
		
		//set different background colors for cards
		initCards();
		initChildCards();
		initHistoryCards();
		
		currentChosenCard= new CardView((CardView)verticalLayout_mainView.getComponent(4));
		currentChosenCard.expandCardView();
		currentChosenCard.removeTransparency();
		//initChildCards();
		//initHistoryCards();

		//search button
		nativeButton_search.setCaption(null);
		nativeButton_search.setIcon(new ThemeResource("images/icons/sidebar/spyglass25.png"));
		nativeButton_search.setStyleName("cardTextMini");
			
	}
	
	/*
	 * Needs to be removed - just for testing purposes
	 */
	public void createRandomCards(){
		Card random[] = new Card[30];
		
		//150 Characters
		String text = "Lorem ipsum dolor sit amet, consectetur adipiscing elit Cras sodales eros ut ipsum ultricies eleifend. Vivamus justo ipsum, rutrum vel orciv vel orciv";
		
		for(int i = 0; i < 30; i++){
			random[i] = new Card (i, (i + 100), text, "Expand", 5, 60, new Timestamp(2015, 5, 25, 12, 0, 0, 0)); 
			
			if(i < 10)
				cardsToMainView.addCard(random[i]);
			else if(i >= 10 && i < 25){
				cardsToChildView.addCard(random[i]);
				random[i].parent = 105;
			}else
				cardsToHistoryView.addCard(random[i]);
			
		}
	}
	
	/**
	 * Initialize Cards that need to be added to the Main View of the Card Explorer
	 * 	Should only be used after a query is made to get the corresponding CardList 
	 * 	from the database.
	 */
	private void initCards(){
		
		while(cardsToMainView.size() > 0){
			
			//get the current first node of the card list
			Card currentCardData = cardsToMainView.getCard();
			
			//get the current card data
			String id = Integer.toString(currentCardData.cardId);
			String pId = Integer.toString(currentCardData.playerId);
			String cardText = currentCardData.textUser;
			String cardType = currentCardData.cardType;
			String parent = Integer.toString(currentCardData.parent);
			String votes = Integer.toString(currentCardData.votes);
			String date = new SimpleDateFormat("MM/dd/yyyy").format(currentCardData.time.getDate());
			
			//create a new card view using the card data.
			CardView newCard = new CardView(id, pId, cardText, cardType, parent, votes, date);
			newCard.setCardType(cardType);
			
			//CardView temp = new CardView(newCard);
			//verticalLayout_historyView.addComponent(temp);
			
			//add card to the component
			verticalLayout_mainView.addComponent(newCard);			
		} 
		
		styleCardsInMainView();
	}
	
	public void initChildCards(){

		while(cardsToChildView.size() > 0){
			
			//System.out.println("init cards: " + i);
			
			//get the current first node of the card list
			Card currentCardData = cardsToChildView.getCard();
			
			//get the current card data
			String id = Integer.toString(currentCardData.cardId);
			String pId = Integer.toString(currentCardData.playerId);
			String cardText = currentCardData.textUser;
			String cardType = currentCardData.cardType;
			String parent = Integer.toString(currentCardData.parent);
			String votes = Integer.toString(currentCardData.votes);
			String date = new SimpleDateFormat("MM/dd/yyyy").format(currentCardData.time.getDate());
			
			//create a new card view using the card data.
			CardView newCard = new CardView(id, pId, cardText, cardType, parent, votes, date);
			newCard.setCardType(cardType);	
			
			//add card to the component
			verticalLayout_childView.addComponent(newCard);	
			
			//mainViewClickListener(newCard);

		}
		
		styleCardsInChildView();
	}
	
	public void initHistoryCards(){
		while(cardsToHistoryView.size() > 0){
			
			//System.out.println("init cards: " + i);
			
			//get the current first node of the card list
			Card currentCardData = cardsToHistoryView.getCard();
			
			//get the current card data
			String id = Integer.toString(currentCardData.cardId);
			String pId = Integer.toString(currentCardData.playerId);
			String cardText = currentCardData.textUser;
			String cardType = currentCardData.cardType;
			String parent = Integer.toString(currentCardData.parent);
			String votes = Integer.toString(currentCardData.votes);
			String date = new SimpleDateFormat("MM/dd/yyyy").format(currentCardData.time.getDate());
			
			//create a new card view using the card data.
			CardView newCard = new CardView(id, pId, cardText, cardType, parent, votes, date);
			newCard.setCardType(cardType);	
			
			//add card to the component
			verticalLayout_historyView.addComponent(newCard);	
		}
		styleCardsInHistoryView();
		
	}
	
	/**
	 * 
	 * @param clickedCard
	 */
	public void mainViewClickListener(CardView clickedCard){
		
		//Listen to the cards text button
		clickedCard.getNativeButton_text().addClickListener(new NativeButton.ClickListener(){
			
			@Override
			public void buttonClick(ClickEvent event) {
				// TODO Auto-generated method stub
				
				//check if the clicked card is the current chosen card
				//if it is not, then minimize the current card and maximize the new chosen card
				if(!clickedCard.equals(currentChosenCard)){

					//Make sure the current card is not null
					try{
						currentChosenCard.addTransparency();
						currentChosenCard.shrinkCardView();
						
						clickedCard.expandCardView();
						clickedCard.removeTransparency();
						
					}catch(NullPointerException e){
						clickedCard.expandCardView();
						clickedCard.removeTransparency();
					}
					
					//Set the clicked card as the new current card
					//verticalLayout_historyView.addComponent(new CardView(currentChosenCard));
					currentChosenCard = new CardView(clickedCard);
					
					//TODO query database for children list
					//TODO remove current children
					//TODO add new children list to the explorer
				}
			}
			
		});		
	}
	
	/**
	 * 
	 * @param clickedCard -> The card that was clicked by the user
	 */
	public void childViewClickListener(CardView clickedCard){
		
		//Listen to the cards text button
		clickedCard.getNativeButton_text().addClickListener(new NativeButton.ClickListener(){
			
			@Override
			public void buttonClick(ClickEvent event) {
				// TODO Auto-generated method stub
				
				try{
					//TODO query database to get clicked card
				
					String id = currentChosenCard.getCardId();
					String pId = currentChosenCard.getUser().getCaption();
					String cardText = currentChosenCard.getNativeButton_text().getCaption();
					String cardType = currentChosenCard.getCardType().getValue();
					String parent = currentChosenCard.getCardParent();
					String votes = currentChosenCard.getVoteCount().getValue();
					String date = currentChosenCard.getDate().getValue();
					CardView temp = new CardView(id, pId, cardText, cardType, parent, votes, date);
					
					//move the current chosen card and add it to the history view
					verticalLayout_historyView.addComponent(temp);
					setBaseCardStyle(temp);
					verticalLayout_historyView.setExpandRatio(temp, 1.0f);
					
					//remove the current list of card in the main view
					verticalLayout_mainView.removeAllComponents();
					
					//move the current child view list move it to the main view
					int numberOfChildren = verticalLayout_childView.getComponentCount();
					for(int index = 0; index < numberOfChildren; index++){
						id = ((CardView)verticalLayout_childView.getComponent(index)).getCardId();
						pId = ((CardView)verticalLayout_childView.getComponent(index)).getUser().getCaption();
						cardText = ((CardView)verticalLayout_childView.getComponent(index)).getNativeButton_text().getCaption();
						cardType = ((CardView)verticalLayout_childView.getComponent(index)).getCardType().getValue();
						parent = ((CardView)verticalLayout_childView.getComponent(index)).getCardParent();
						votes = ((CardView)verticalLayout_childView.getComponent(index)).getVoteCount().getValue();
						date = ((CardView)verticalLayout_childView.getComponent(index)).getDate().getValue();
						CardView temp2 = new CardView(id, pId, cardText, cardType, parent, votes, date);
						
						verticalLayout_mainView.addComponent(temp2);
						
						setBaseCardStyle(temp2);
						verticalLayout_mainView.setExpandRatio(temp2, 1.0f);
						
						//check if the card that is currently indexed is the clicked card expand the view and remove the styling
						if(id.equalsIgnoreCase(clickedCard.getCardId())){
							//set the clicked card as the new chosen card
							currentChosenCard = new CardView(temp2);
						}
					}
					
					//style the cards added to the Main View
					styleCardsInMainView();
					//remove the current child components
					verticalLayout_childView.removeAllComponents();
					
					//TODO query the database to get the children of the currently clicked card
					//add the newly acquired child cards to the ChildView
					//Set the styling of the card
					//
					
				}catch(NullPointerException e){
					//TODO ADD ERROR HANDLING
				}
				
				//Focus current chosen card in main view
				currentChosenCard.removeTransparency();
				currentChosenCard.expandCardView();
			}
			
		});		
	}
	
	/**
	 * Style the cards in the main view with the default values
	 */
	private void styleCardsInMainView(){
		int cardsInMainView = verticalLayout_mainView.getComponentCount();
		
		for(int index = 0; index < cardsInMainView; index++){
			//set base styling
			setBaseCardStyle(((CardView)verticalLayout_mainView.getComponent(index)));
			
			//set expantionRatio of this card
			verticalLayout_mainView.setExpandRatio(((CardView)verticalLayout_mainView.getComponent(index)), 1.0f);
			
			//make cards transparent by default
			((CardView)verticalLayout_mainView.getComponent(index)).addTransparency();
			
			//attach the appropriate listener
			mainViewClickListener(((CardView)verticalLayout_mainView.getComponent(index)));
		}
	}
	
	/**
	 * Style the cards in the child view with the default values
	 */
	private void styleCardsInChildView(){
		int cardsInChildView = verticalLayout_childView.getComponentCount();
		
		for(int index = 0; index < cardsInChildView; index++){
			//set base styling
			setBaseCardStyle(((CardView)verticalLayout_childView.getComponent(index)));
			
			//set expantionRatio of this card
			verticalLayout_childView.setExpandRatio(((CardView)verticalLayout_childView.getComponent(index)), 1.0f);
			
			//make cards transparent by default
			//((CardView)verticalLayout_2.getComponent(index)).addTransparency();
			
			//attach the appropriate listener
			childViewClickListener(((CardView)verticalLayout_childView.getComponent(index)));
		}
	}

	/**
	 * Style the cards in the history view with the default values
	 */
	private void styleCardsInHistoryView(){
		int cardsInHistoryView = verticalLayout_historyView.getComponentCount();
		
		for(int index = 0; index < cardsInHistoryView; index++){
			//set base styling
			setBaseCardStyle(((CardView)verticalLayout_historyView.getComponent(index)));
			
			//set expantionRatio of this card
			verticalLayout_historyView.setExpandRatio(((CardView)verticalLayout_historyView.getComponent(index)), 1.0f);
			
			//make cards transparent by default
			//((CardView)verticalLayout_2.getComponent(index)).addTransparency();
			
			//attach the appropriate listener
			mainViewClickListener(((CardView)verticalLayout_historyView.getComponent(index)));
		}
	}	
	
	/**
	 * Provides the CardView with a baseline style to fit within the Explorer
	 * 
	 * @param card -> CardView object that will receive the basic styling values
	 */
 	private void setBaseCardStyle(CardView card){
 		card.setImmediate(false);
 		card.setWidth("340px");
 		card.setHeight("-1px");
 	}
	
	/**
	 * 
	 * @param clickedCard
	 */
	public void historyViewClickListener(CardView clickedCard){
		
		//Listen to the cards text button
		clickedCard.getNativeButton_text().addClickListener(new NativeButton.ClickListener(){
					
			@Override
			public void buttonClick(ClickEvent event) {
				// TODO Auto-generated method stub
						
				//check if the clicked card is the current chosen card
				//if it is not, then minimize the current card and maximize the new chosen card
				if(!clickedCard.equals(currentChosenCard)){
					//Make sure the current card is not null
					try{
						currentChosenCard.addTransparency();
						currentChosenCard.shrinkCardView();
								
						clickedCard.expandCardView();
						clickedCard.removeTransparency();
								
					}catch(NullPointerException e){
						clickedCard.expandCardView();
						clickedCard.removeTransparency();
					}
							
					//Set the clicked card as the new current card
					currentChosenCard = new CardView(clickedCard);
				}
			}
					
		});	
	}
	
	@AutoGenerated
	private HorizontalLayout buildMainLayout() {
		// common part: create layout
		mainLayout = new HorizontalLayout();
		mainLayout.setImmediate(false);
		mainLayout.setWidth("100%");
		mainLayout.setHeight("500px");
		mainLayout.setMargin(false);
		
		// top-level component properties
		setWidth("100.0%");
		setHeight("500px");
		
		// panel_tree
		panel_tree = buildPanel_tree();
		mainLayout.addComponent(panel_tree);
		mainLayout.setExpandRatio(panel_tree, 1.2f);
		
		// panel_currentCards
		panel_currentCards = buildPanel_currentCards();
		mainLayout.addComponent(panel_currentCards);
		mainLayout.setExpandRatio(panel_currentCards, 3.0f);
		
		// verticalLayout_4
		verticalLayout_4 = buildVerticalLayout_4();
		mainLayout.addComponent(verticalLayout_4);
		mainLayout.setExpandRatio(verticalLayout_4, 2.5f);
		
		return mainLayout;
	}

	@AutoGenerated
	private Panel buildPanel_tree() {
		// common part: create layout
		panel_tree = new Panel();
		panel_tree.setImmediate(false);
		panel_tree.setWidth("100.0%");
		panel_tree.setHeight("100.0%");
		
		// verticalLayout_historyView
		verticalLayout_historyView = new VerticalLayout();
		verticalLayout_historyView.setImmediate(false);
		verticalLayout_historyView.setWidth("300px");
		verticalLayout_historyView.setHeight("-1px");
		verticalLayout_historyView.setMargin(false);
		verticalLayout_historyView.setSpacing(true);
		panel_tree.setContent(verticalLayout_historyView);
		
		return panel_tree;
	}

	@AutoGenerated
	private Panel buildPanel_currentCards() {
		// common part: create layout
		panel_currentCards = new Panel();
		panel_currentCards.setImmediate(false);
		panel_currentCards.setWidth("100.0%");
		panel_currentCards.setHeight("100.0%");
		
		// verticalLayout_mainView
		verticalLayout_mainView = new VerticalLayout();
		verticalLayout_mainView.setImmediate(false);
		verticalLayout_mainView.setWidth("375px");
		verticalLayout_mainView.setHeight("-1px");
		verticalLayout_mainView.setMargin(false);
		verticalLayout_mainView.setSpacing(true);
		panel_currentCards.setContent(verticalLayout_mainView);
		
		return panel_currentCards;
	}

	@AutoGenerated
	private VerticalLayout buildVerticalLayout_4() {
		// common part: create layout
		verticalLayout_4 = new VerticalLayout();
		verticalLayout_4.setImmediate(false);
		verticalLayout_4.setWidth("100.0%");
		verticalLayout_4.setHeight("100.0%");
		verticalLayout_4.setMargin(false);
		
		// horizontalLayout_1
		horizontalLayout_1 = buildHorizontalLayout_1();
		verticalLayout_4.addComponent(horizontalLayout_1);
		verticalLayout_4.setExpandRatio(horizontalLayout_1, 0.2f);
		
		// panel_cardChildren
		panel_cardChildren = buildPanel_cardChildren();
		verticalLayout_4.addComponent(panel_cardChildren);
		verticalLayout_4.setExpandRatio(panel_cardChildren, 2.0f);
		
		return verticalLayout_4;
	}

	@AutoGenerated
	private HorizontalLayout buildHorizontalLayout_1() {
		// common part: create layout
		horizontalLayout_1 = new HorizontalLayout();
		horizontalLayout_1.setImmediate(false);
		horizontalLayout_1.setWidth("375px");
		horizontalLayout_1.setHeight("-1px");
		horizontalLayout_1.setMargin(false);
		
		// textField_search
		textField_search = new TextField();
		textField_search.setImmediate(false);
		textField_search.setWidth("90px");
		textField_search.setHeight("25px");
		horizontalLayout_1.addComponent(textField_search);
		
		// nativeButton_search
		nativeButton_search = new NativeButton();
		nativeButton_search.setCaption("NativeButton");
		nativeButton_search.setImmediate(true);
		nativeButton_search.setWidth("-1px");
		nativeButton_search.setHeight("-1px");
		horizontalLayout_1.addComponent(nativeButton_search);
		
		// label_sort
		label_sort = new Label();
		label_sort.setImmediate(false);
		label_sort.setWidth("-1px");
		label_sort.setHeight("-1px");
		label_sort.setValue("Sort By:");
		horizontalLayout_1.addComponent(label_sort);
		horizontalLayout_1.setComponentAlignment(label_sort, new Alignment(48));
		
		// comboBox_1
		comboBox_1 = new ComboBox();
		comboBox_1.setImmediate(false);
		comboBox_1.setWidth("90px");
		comboBox_1.setHeight("25px");
		horizontalLayout_1.addComponent(comboBox_1);
		
		return horizontalLayout_1;
	}

	@AutoGenerated
	private Panel buildPanel_cardChildren() {
		// common part: create layout
		panel_cardChildren = new Panel();
		panel_cardChildren.setImmediate(false);
		panel_cardChildren.setWidth("100.0%");
		panel_cardChildren.setHeight("100.0%");
		
		// verticalLayout_childView
		verticalLayout_childView = new VerticalLayout();
		verticalLayout_childView.setImmediate(false);
		verticalLayout_childView.setWidth("375px");
		verticalLayout_childView.setHeight("-1px");
		verticalLayout_childView.setMargin(false);
		verticalLayout_childView.setSpacing(true);
		panel_cardChildren.setContent(verticalLayout_childView);
		
		return panel_cardChildren;
	}

}
